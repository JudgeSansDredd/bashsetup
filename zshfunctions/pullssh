# Constants
LASTPASS_SSH_FOLDER="Programming\\SSH"
LASTPASS_PEM_FOLDER="Programming\\SSH\\pem"
SSH_CONFIG_FILE="${HOME}/.ssh/config"
SSH_CONFD="${HOME}/.ssh/config.d"
PEM_DIRECTORY="${HOME}/.ssh/keys"
TERMINAL_HEIGHT=`tput lines`
BOX_HEIGHT=`printf "%.0f" $(echo "scale=2; $TERMINAL_HEIGHT * .5" | bc)`
TERMINAL_WIDTH=`tput cols`
BOX_WIDTH=`printf "%.0f" $(echo "scale=2; $TERMINAL_WIDTH * .75" | bc)`

# Ensure whiptail
if hash whiptail 2>/dev/null; then
    echo ""
else
    if [ "$(uname)" = "Darwin" ]; then
        brew install newt
    elif [ "$(expr substr $(uname -s) 1 5)" = "Linux" ]; then
        sudo apt install whiptail
    fi
fi

# Set up initial ssh config
echo "Host *
	IdentitiesOnly yes
	AddKeysToAgent yes
	UseKeychain yes
	IdentityFile ~/.ssh/id_rsa

Include config.d/*.config" > $SSH_CONFIG_FILE

# Make config.d directory if it doesn't exist
mkdir -p $SSH_CONFD

# Grab configs from lastpass
raw_config_names=($(lpass ls $LASTPASS_SSH_FOLDER | awk '{print $1}'))
# raw_config_names=($(lpass ls $LASTPASS_SSH_FOLDER | awk '(NR>1){print $1}'))

# Create whiptail options for checklist
whiptail_config_names=()
for VALUE in "${raw_config_names[@]}"
do
    trunc_config=$(basename $VALUE)
    whiptail_config_names+=("$trunc_config" "" ON)
done

# Select which ssh configs to download
choices=($(whiptail --separate-output --checklist "What config files would you like to pull?" $BOX_HEIGHT $BOX_WIDTH 5 "${whiptail_config_names[@]}" 3>&2 2>&1 1>&3))
exitstatus=$?

# If cancel was not pressed, iterate through choices and download
if [ $exitstatus = 0 ]; then
    # OK was pressed
    for choice in "${choices[@]}"
    do
        (lpass show "${LASTPASS_SSH_FOLDER}/${choice}" --notes) > "${SSH_CONFD}/${choice}.config"
    done
fi

# make keys directory if it doesn't exist
mkdir -p $PEM_DIRECTORY

# Grab list of pem keys
raw_pem_names=($(lpass ls $LASTPASS_PEM_FOLDER | awk '{print $1}'))

# Create whiptail options for checklist
whiptail_pem_names=()
for VALUE in "${raw_pem_names[@]}"
do
    trunc_pem=$(basename $VALUE)
    whiptail_pem_names+=("$trunc_pem" "" ON)
done

# Select which pem keys to download
choices=($(whiptail --separate-output --checklist "What pem keys would you like to pull?" $BOX_HEIGHT $BOX_WIDTH 5 "${whiptail_pem_names[@]}" 3>&2 2>&1 1>&3))
exitstatus=$?

# If cancel was not pressed, iterate through choices and download
if [ $exitstatus = 0 ]; then
    # OK was pressed
    for choice in "${choices[@]}"
    do
        (lpass show "${LASTPASS_PEM_FOLDER}/${choice}" --field "Private Key") > "${PEM_DIRECTORY}/${choice}.pem"
    done
fi

