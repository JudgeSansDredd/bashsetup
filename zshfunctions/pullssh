# Constants
LASTPASS_SSH_FOLDER="Programming\\SSH"
LASTPASS_PEM_FOLDER="Programming\\SSH\\pem"
SSH_CONFIG_FILE="${HOME}/.ssh/config"
SSH_CONFIG_CONFD="${HOME}/.ssh/config.d"
PEM_DIRECTORY="${HOME}/.ssh/keys"
TERMINAL_HEIGHT=`tput lines`
BOX_HEIGHT=`printf "%.0f" $(echo "scale=2; $TERMINAL_HEIGHT * .5" | bc)`
TERMINAL_WIDTH=`tput cols`
BOX_WIDTH=`printf "%.0f" $(echo "scale=2; $TERMINAL_WIDTH * .75" | bc)`

# Ensure whiptail
if hash whiptail 2>/dev/null; then
    echo ""
else
    if [ "$(uname)" = "Darwin" ]; then
        brew install newt
    elif [ "$(expr substr $(uname -s) 1 5)" = "Linux" ]; then
        sudo apt install whiptail
    fi
fi

# Set up initial ssh config
echo "Host *
	IdentitiesOnly yes
	AddKeysToAgent yes
	UseKeychain yes
	IdentityFile ~/.ssh/id_rsa

Include config.d/*.config" > $SSH_CONFIG_FILE

# Make config.d directory if it doesn't exist
mkdir -p $SSH_CONFIG_CONFD

# Grab configs from lastpass
RAW_CONFIG_NAMES=($(lpass ls $LASTPASS_SSH_FOLDER | awk '{print $1}'))
# RAW_CONFIG_NAMES=($(lpass ls $LASTPASS_SSH_FOLDER | awk '(NR>1){print $1}'))

# Create whiptail options for checklist
WHIPTAIL_CONFIG_NAMES=()
for VALUE in "${RAW_CONFIG_NAMES[@]}"
do
    TRUNC_CONFIG=$(basename $VALUE)
    WHIPTAIL_CONFIG_NAMES+=("$TRUNC_CONFIG" "" OFF)
done

# Select which ssh configs to download
CHOICES=($(whiptail --separate-output --checklist "What config files would you like to get?" $BOX_HEIGHT $BOX_WIDTH 5 "${WHIPTAIL_CONFIG_NAMES[@]}" 3>&2 2>&1 1>&3))
exitstatus=$?

# If cancel was not pressed, iterate through choices and download
if [ $exitstatus = 0 ]; then
    # OK was pressed
    for CHOICE in "${CHOICES[@]}"
    do
        (lpass show "${LASTPASS_SSH_FOLDER}/${CHOICE}" --notes) > "${SSH_CONFIG_CONFD}/${CHOICE}.config"
    done
else
    # Cancel was pressed
    exit
fi

# make keys directory if it doesn't exist
mkdir -p $PEM_DIRECTORY

# # Grab list of pem keys
RAW_PEM_NAMES=($(lpass ls $LASTPASS_PEM_FOLDER | awk '{print $1}'))

# Create whiptail options for checklist
WHIPTAIL_PEM_NAMES=()
for VALUE in "${RAW_PEM_NAMES[@]}"
do
    TRUNC_PEM=$(basename $VALUE)
    WHIPTAIL_PEM_NAMES+=("$TRUNC_PEM" "" OFF)
done

# Select which pem keys to download
CHOICES=($(whiptail --separate-output --checklist "What pem keys would you like to get?" $BOX_HEIGHT $BOX_WIDTH 5 "${WHIPTAIL_PEM_NAMES[@]}" 3>&2 2>&1 1>&3))
exitstatus=$?

# If cancel was not pressed, iterate through choices and download
if [ $exitstatus = 0 ]; then
    # OK was pressed
    for CHOICE in "${CHOICES[@]}"
    do
        (lpass show "${LASTPASS_PEM_FOLDER}/${CHOICE}" --field "Private Key") > "${PEM_DIRECTORY}/${CHOICE}.pem"
    done
else
    # Cancel was pressed
    exit
fi

